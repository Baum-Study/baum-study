## 파드의 컨테이너 자동 복구 방법

파드의 컨테이너 자동 복구 방법 `셀프 힐링`이라고 합니다.  
셀프 힐링은 파드의 컨테이너가 비정상적으로 종료되었을 때 즉시 다시 시작되도록 하는 기능입니다.  

## 파드의 동작 보증 기능

파드는 비정상적으로 종료되었을 때 즉시 다시 살아난다고 했는데 이는 deployment나 replicaset 같은 리소스를 사용하여 파드를 관리할 때만 가능합니다.  
이처럼 `kubectl run` 명령어로 생성한 파드는 셀프 힐링이 되지 않습니다.  
왜냐하면 파드는 죽으면 같은 deployment에 속한 다른 파드가 즉시 생성되어 대체하기 떄문입니다.  

![img.png](../image/정철희1.png)

## 노드 자원 보호하기

우리는 파드를 관리하는 방법을 배웠는데 노드는 어떻게 관리해야할까요?  
일단 노드는 파드를 실행하는 물리적인 서버입니다.(CPU, 메모리, 디스크, 네트워크 등의 자원을 가지고 있습니다.)  
마스터 노드는 하나지만 워커 노드는 여러개가 있을 수 있습니다.  
쿠버네티스는 파드를 할당할 때 여러 노드에 균등하게 할당합니다.  
하지만 문제가 있을 노드에 파드를 할당하면 안되기 때문에 노드에는 리소스를 보호하는 `cordon`이라는 명령어가 있습니다.  
cordon 명령어를 사용하면 노드에 상태는 `SchedulingDisabled`로 변경되어 파드가 할당되지 않습니다.  
그리고 만약 노드에 문제가 해결이 되었다면 `uncordon` 명령어를 사용하여 다시 노드에 파드가 할당 시킬 수 있습니다.  

## 노드 유지보수하기
노드에 할당하지 않게 하는 방법은 `cordon` 명령어를 사용하면 되지만 노드를 유지보수할 때는 `drain` 명령어를 사용합니다.  
drin 명령어를 사용하면 노드에 있는 파드를 다른 노드로 이동시키고 노드를 비워줍니다.  
정확하게는 노드에 있는 파드를 삭제하고 다른 노드에 다시 생성하는거죠.  
그런데 노드마다 지울수 없는 DaemonSet이라는 파드가 1개씩 있어서 노드를 비우려면 DaemonSet을 무시하고 다른 모든 파드들을 삭제해야 합니다.  

## 파드 업데이트하고 복구하기
파드의 버전들을 record라는 옵션을 사용하여 기록을 남길 수 있습니다.  
또한 파드의 예전 버전을 확인하려면 `kubectl rollout history` 명령어를 사용합니다.  

### 업데이트 실패 시 복구하기
파드를 배포하다가 문제가 발생한다면 파드의 상태는 pending 상태로 남아있게 됩니다.  
이때 `kubectl rollout undo` 명령어를 사용하여 이전 버전으로 롤백할 수 있습니다.  