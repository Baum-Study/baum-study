# 도커를 알아야 하는 이유

## [1] 파드, 컨테이너, 도커, 쿠버네티스의 관계

### 앞 내용 정리

- 파드들은 워커 노드라는 노드 단위로 관리하며, 워커 노드와 마스터 노드가 모여 쿠버네티스 클러스터가 됩니다.
- 파드들은 1개 이상의 컨테이너로 이루어져 있습니다.
- 정리하자면, 컨테이너들을 돌보는 것이 파드고, 파드를 돌보는 것이 쿠버네티스 워커  노드이며, 워커 노드를 돌보는 것이 쿠버네티스 마스터입니다.

### 컨테이너

- 컨테이너 : 하나의 운영 체제 안에서 커널을 공유하며 개별적인 실행 환경을 제공하는 격리된 공간입니다.
- 개별적인 실행 환경 : CPU, 네트워크, 메모리와 같은 시스템 자원을 독자적으로 사용하도록 할당된 환경을 말합니다.
- 개별적인 실행 환경에서는 실행되는 프로세스를 구분하는 ID도 컨테이너 안에 격리돼 관리됩니다.
- 각 컨테이너 내부에서 실행되는 애플리케이션들은 서로 영향을 미치지 않고 독립적으로 작동할 수 있습니다.

### 도커의 등장

- 각 컨테이너가 독립적으로 작동하기 때문에 여러 컨테이너를 효과적으로 다룰 방법이 필요해졌습니다.
- 해당 방법을 다루는 과정을 쉽게 만들어주는 도구로 도커가 등장하였습니다.
- 도커를 사용하면 사용자가 따로 신경쓰지 않아도 컨테이너를 생성할 때 개별적인 실행 환경을 분리하고 자원을 할당합니다.

## [2] 다양한 컨테이너 관리 도구

- 컨테이너 관리 도구는 도커 외에도 여러가지가 있습니다.

### 컨테이너디

- 도커사에서 컨테이너 런타임 부분을 분리하여 만든 오픈 소스 컨테이너 관리 도구입니다. 컨테이너 관리 도구를 직접 개발하려는 개발자에게 적합합니다.

### 크라이오

- 레드햇에서 개발해 2019년 클라우드 네이티브 컴퓨팅 재단에 기부한 오프소스 프로젝트입니다. 다른 도구보다 가볍고 단순하지만 아직 널리 사용되고 있지는 않습니다.

### 카타 컨테이너

- 오픈스택 재단에서 후원하는 오픈소스 컨테이너 관리 도구입니다. 가상 머신을 통해 컨테이너를 격리하므로 기술적으로는 보안에 좀 더 강하지만, 필요한 CPU나 메모리의 크기가 기존 컨테이너 방식보다 큽니다.

### 도커

- Docker사에서 2013년에 만든 컨테이너 관리 도구로, 컨테이너 고나리 기능 외에도 컨테이너를 실행하는데 필요한 이미지를 만들거나 공유하는 등의 다양한 기능을 제공합니다.
- 도커는 사용자가 명령어를 입력하는 도구 (CLI)와 명령을 받아들이는 도커 데몬으로 구성돼 있습니다.
- 도커와 쿠버네티스를 함께 설치할 경우 쿠버네티스 컨테이너 오케스트레이션을 위해 도커에 포함된 컨테이너디를 활용합니다.

---

# 도커로 컨테이너 다루기

## [1] 컨테이너 이미지 알아보기

### 이미지 검색하고 내려받기

- 이미지는 ‘레지스트리’라고 하는 저장소에 모여 있습니다.
- 레지스트리는 도커 허브처럼 공개된 유명 레지스트일 수 있고, 내부에 구축한 레지스트리일 수도 있습니다.

```bash
#1. nginx 이미지 찾아보기
docker search nginx

#2. 이미지 내려받기
docker pull nginx
```

- 이미지를 내려받을 때 사용하는 태그, 레이어, 이미지의 고유 식별 값 등을 볼 수 있습니다.
- (1) 태그 : 아무런 조건을 주지 않고 이미지 pull 을 수행하면 기본으로 latest 태그가 적용됩니다. (latest : 가장 최신 이미지 의미, 이미지 버전마다 다를 수 있음)
- (2) 레이어 : 하나의 이미지는 여러 개의 레이어로 이루어져 있어서 레이어마다 pull complete 메시지가 발생합니다.
- (3) 다이제스트 : 이미지의 고유 식별자로 이미지에 포함된 내용과 이미지의 생성 환경을 식별할 수 있습니다. 식별자는 해시 함수로 생성되며 이미지가 동일한지 검증하는데 사용합니다. 태그가 같다고 해서 같은 이미지라고 할 수 없습니다. 다이제스트는 고유한 값이므로 다이제스트가 같은 이미지만 같다고 말합니다.
- (4) 상태 : 이미지를 내려받은 레지스트리, 이미지, 태그 등의 상태 정보를 확인할 수 있습니다. 형식은 ‘레지스트리 이름/이미지 이름:태그’ 입니다.

### 이미지 태그

- 태그 : 이름이 동일한 이미지에 추가하는 식별자입니다.
- 이미지를 내려받거나 이미지를 기반으로 컨테이너를 구동할 대는 이미지 이름만 사용하고 태그를 명시하지 않으면 latest 태그를 기본으로 사용합니다.
- 이미지 태그와 관련된 정보는 해당 이미지의 도커 허브 메뉴 중 Tags 탭에서 확인할 수 있습니다.

### 이미지와 레이어 구조

- 컨테이너 이미지는 실행 파일이라고 했는데, 사실 이미지는 애플리케이션과 각종 파일을 담고 있다는 점에서 ZIP 같은 압축 파일에 더 가깝습니다.
- 하지만 이미지는 압축 파일과는 다르게 여러 이미지에 동일한 레이어를 공유하므로 전체 용량이 감소합니다.

```bash
#1. 이미지가 차지하는 용량 확인(1)
docker history nginx:stable

#2. 이미지가 차지하는 용량 확인(2)
docker history nginx:latest
```

## [2] 컨테이너 실행하기

```bash
#1. 새로운 컨테이너 실행
docker run -d --restart always nginx

#2. 컨테이너 상태 확인
docker ps

#3. 컨테이너 지정하여 검색
docker ps -f id=cec7

#4. 컨테이너가 제공하는 nginx 웹 페이지 정보 확인
curl 127.0.0.1

#5. 외부에서도 컨테이너 내부에 접속할 수 있게 새 컨테이너 구동해보기
docker run -d -p 8080:80 --name nginx-exposed --restart always nginx

#6. 5번 정상작동 확인
docker ps -f name=nginx-exposed
```

## [3] 컨테이너 내부 파일 변경하기

### 컨테이너 내부에서 외부의 파일 사용할 수 있는 방법 (4가지 제공)

- (1) docker cp :  docker cp <호스트 경로>  <컨테이너 이름>:<컨테이너 내부 경로> 형식으로 호스트에 위치한 파일을 구동 중인 컨테이너 내부에 복사합니다. 임시로 필요한 파일이 있는 경우 단편적으로 전송하기 위해서 사용합니다. 또는 컨테이너에 저장돼 있는 설정 및 로그를 추출해 확인하는 목적으로도 사용합니다.
- (2) Dockerfile ADD : 이미지는 Dockerfile을 기반으로 만들어지는데, Dockerfile ADD 라는 구문으로 컨테이너 내부로 복사할 파일을 지정하면 이미지를 빌드할 때 지정한 파일이 이미지 내부로 복사됩니다. 구동한 컨테이너에서 복사한 파일을 사용할 수 있지만 사용자가 원하는 파일을 선택해 사용할 수 없다는 약점이 존재합니다.
- (3) 바인드 마운트 : 호스트의 파일 시스템과 컨테이너 내부를 연결해 어느 한쪽에서 작업한 내용이 양쪽에 동시에 반영되는 방법입니다.
- (4) 볼륨 : 호스트의 파일 시스템과 컨테이너 내부를 연결하는 것은 바인드 마운트와 동일하지만, 호스트의 특정 디렉터리가 아닌 도커가 관리하는 볼륨을 컨테이너와 연결한다는 차이점이 잇습니다. 여기서 말하는 볼륨은 쿠버네티스에서 살펴본 볼륨 구조와 유사합니다.

## [4] 사용하지 않는 컨테이너 정리하기

- 사용하지 않는 컨테이너들은 공간 확보를 위해 삭제하는 것이 좋습니다.

```bash
#1. 컨테이너 이미지 삭제
docker rm <컨테이너 이름 | id>
```
