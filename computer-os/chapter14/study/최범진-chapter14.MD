# 가상 메모리

가상 메모리는 컴퓨터 시스템에서 물리적인 메모리보다 더 큰 메모리 공간을 사용하는 것을 가능하게 하는 기술입니다. 이를 통해 프로세스는 연속적인 메모리 공간을 가지며, 필요한 만큼 메모리를 사용할 수 있게 됩니다.

# 연속 메모리 할당

연속 메모리 할당은 프로세스에 연속적인 메모리 공간을 할당하는 방식입니다. 이는 프로세스가 필요로 하는 메모리 공간이 연속적으로 할당되며, 프로세스의 효율적인 실행을 돕습니다.

## 스와핑

스와핑은 메모리 관리 기법 중 하나로, 메모리에서 사용되지 않는 프로세스를 보조 기억장치로 내보내고 실행할 프로세스를 메모리로 들여오는 방식을 말합니다. 이를 통해 실제 메모리 크기보다 큰 메모리 주소 공간을 요구하는 프로세스들도 동시 실행할 수 있습니다.

- **스왑영역**: 오랫동안 사용되지 않은 프로세스들이 이동되는 보조 기억장치의 일부 영역.
- **스왑 아웃**: 현재 실행되지 않는 프로세스가 메모리에서 스왑 영역으로 옮겨지는 것.
- **스왑 인**: 스왑 영역에 있던 프로세스가 다시 메모리로 옮겨오는 것. 스왑 아웃 되었던 프로세스가 다시 스왑 인될 때는 스왑 아웃 전의 물리 주소와는 다른 주소에 적재될 수 있습니다.

## 메모리 할당

프로세스는 메모리 내의 빈 공간에 할당되어야 합니다. 메모리 내에 빈 공간이 여러 개 있다면 프로세스를 어디에 배치할지 결정해야 합니다. 메모리 할당 방법에는 다음과 같은 방식이 있습니다.

### 최초 적합

최초 적합은 운영체제가 메모리 내의 빈 공간을 순서대로 검색하다가 적재할 수 있는 공간을 발견하면 그 공간에 프로세스를 배치하는 방식입니다. 즉, 프로세스가 적재될 수 있는 공간을 발견하는 즉시 메모리를 할당하는 방식으로 검색을 최소화할 수 있고, 결과적으로 빠른 할당이 가능합니다.

### 최적 적합

최적 적합은 운영체제가 빈 공간을 모두 검색해 본 후, 프로세스가 적재될 수 있는 공간 중 가장 작은 공간에 프로세스를 배치하는 방식입니다. 이 방법은 메모리 공간을 가장 효율적으로 사용할 수 있게 도와줍니다.

### 최악 적합

최악 적합은 운영체제가 빈 공간을 모두 검색해 본 후, 프로세스가 적재될 수 있는 공간 중 가장 큰 공간에 프로세스를 배치하는 방식입니다. 이는 큰 빈 공간을 먼저 사용하게 되어 남은 빈 공간의 크기를 줄이는 효과를 기대할 수 있습니다.

## 외부 단편화

외부 단편화란 프로세스들이 메모리에 연속적으로 할당되는 환경에서 프로세스들이 실행되고 종료되기를 반복하며 메모리 사이사이에 빈 공간들이 생기는 현상을 말합니다. 이러한 빈 공간들은 작아서 프로세스를 할당하기 어렵게 만들며, 메모리가 낭비되는 결과를 초래합니다.

### 메모리 압축

메모리 압축 또는 메모리 조각 모음은 여기저기 흩어진 메모리의 빈 공간들을 하나로 모으는 방식입니다. 이는 메모리 내의 저장된 프로세스를 적당히 재배치시켜 작은 빈 공간들을 하나의 큰 빈 공간으로 만드는 방법입니다.

- 작은 빈 공간을 하나로 모으는 동안 시스템은 하던 일을 중지해야 하고, 메모리에 있는 내용을 옮기는 작업은 오버헤드를 발생시키며, 이동 시 최적화 방법을 명확히 하기 어렵습니다.

## 내부 단편화

내부 단편화란 메모리 할당 단위가 고정되어 있는 환경에서 발생하는 문제로, 프로세스가 필요한 메모리보다 더 큰 고정된 크기의 메모리 블록을 할당받을 때 발생합니다. 즉, 프로세스가 실제로 사용하는 메모리보다 할당된 메모리가 더 크기 때문에 남는 부분이 생기는 현상을 내부 단편화라고 합니다. 이러한 남는 부분은 사용되지 않지만 할당된 상태로 남아 있게 되므로 메모리가 비효율적으로 사용됩니다.

# 페이징을 통한 가상 메모리 관리

## 페이징 기법

페이징은 메모리 관리 기법 중 하나로, 물리 주소 공간을 일정한 크기의 프레임 단위로 나누고, 프로세스의 논리 주소 공간을 동일한 크기의 페이지 단위로 나눈 후 각 페이지를 프레임에 할당하는 방식입니다. 이로 인해 프로세스 전체가 아닌 필요한 페이지만 메모리에 적재하여 물리 메모리보다 큰 프로세스를 실행할 수 있습니다. 페이징을 사용하는 시스템에서는 프로세스 전체를 스왑 인/아웃하는 것이 아니라 페이지 단위로 스왑 인/아웃이 이루어집니다.

- **페이지 인**: 보조기억장치에 있는 페이지를 물리 메모리로 불러오는 작업.
- **페이지 아웃**: 물리 메모리에 있는 페이지를 보조기억장치로 내보내는 작업.

### 페이지 테이블

페이지 테이블은 프로세스의 논리 주소와 물리 주소를 매핑하는 구조로, 각 프로세스가 메모리에 불연속적으로 배치되더라도 연속적인 논리 주소 공간을 제공할 수 있습니다. 페이지 테이블을 통해 페이지 번호를 이용해 페이지가 적재된 프레임을 찾을 수 있습니다.

### 페이지 테이블 베이스 레지스터 (PTBR)

PTBR은 CPU 내에 존재하며 각 프로세스의 페이지 테이블이 위치한 주소를 가리킵니다. 이를 통해 CPU는 현재 실행 중인 프로세스의 페이지 테이블에 빠르게 접근할 수 있습니다.

### TLB (Translation Lookaside Buffer)

TLB는 페이지 테이블의 캐시로서, 페이지 테이블 접근 시간을 줄이기 위해 CPU 곁에 위치한 작은 메모리입니다. TLB는 자주 사용되는 페이지 테이블 항목을 저장하여 빠른 주소 변환을 가능하게 합니다.

- **TLB 히트**: CPU가 발생한 논리 주소에 대한 페이지 번호가 TLB에 존재하는 경우.
- **TLB 미스**: 페이지 번호가 TLB에 없는 경우, 메모리 내의 페이지 테이블에 접근하여 페이지가 적재된 프레임을 찾는 경우.

## 페이징에서의 주소 변환

페이징 시스템에서는 모든 논리 주소가 기본적으로 페이지 번호와 변위로 이루어져 있습니다.

### 페이지 번호

페이지 번호는 접근하고자 하는 페이지를 식별하는 번호로, 논리 주소의 페이지 번호는 페이지 테이블을 통해 물리 주소의 프레임 번호로 변환됩니다.

### 변위

변위는 해당 페이지 내에서의 정확한 위치를 가리키며, 프레임의 시작 번지로부터의 오프셋을 나타냅니다.

## 페이지 테이블 엔트리

페이지 테이블 엔트리는 페이지 번호와 프레임 번호 외에도 유효 비트, 보호 비트, 참조 비트, 수정 비트를 포함하고 있습니다.

### 유효 비트

유효 비트는 현재 해당 페이지에 접근 가능한지를 나타냅니다. 페이지가 메모리에 적재되어 있으면 1, 그렇지 않으면 0이 됩니다. 유효 비트가 0인 페이지에 접근하려고 하면 `페이지 폴트` 예외가 발생합니다.

### 보호 비트

보호 비트는 페이지의 접근 권한을 설정합니다. 0은 읽기 전용, 1은 읽기/쓰기 가능을 나타냅니다. 읽기 전용 페이지에 쓰기를 시도하면 운영체제가 이를 막습니다. 세 개의 비트로 읽기(r), 쓰기(w), 실행(x)의 권한을 조합할 수 있습니다.

### 참조 비트

참조 비트는 페이지가 적재된 이후 CPU가 해당 페이지에 접근했는지 여부를 나타냅니다. 접근한 적이 있으면 1, 그렇지 않으면 0이 됩니다.

### 수정 비트

수정 비트는 페이지가 변경된 적이 있는지를 나타내며, `더티 비트`라고도 불립니다. 비트가 1이면 변경된 페이지, 0이면 변경되지 않은 페이지입니다. 이는 페이지가 메모리에서 사라질 때 보조기억장치에 쓰기 작업을 해야 하는지 판단하는 데 사용됩니다.

## 쓰기 시 복사

쓰기 시 복사(Copy-on-Write)는 부모 프로세스 또는 자식 프로세스 중 하나가 페이지에 쓰기 작업을 시작할 때 해당 페이지를 별도의 공간으로 복제하는 기법입니다. 이를 통해 프로세스 생성 시간을 줄이고 메모리 공간을 절약할 수 있습니다.

## 계층적 페이징

계층적 페이징은 페이지 테이블을 여러 단계로 나누어 관리하는 방식으로, 다단계 페이지 테이블 기법이라고도 합니다. 이는 페이지 테이블을 여러 개의 작은 페이지로 분할하고, 외부 페이지 테이블을 사용하여 분할된 페이지 테이블을 가리키게 합니다.

외부 페이지 테이블은 항상 메모리에 유지되고, 나머지 페이지 테이블은 필요할 때만 메모리에 적재하여 메모리 사용을 효율적으로 관리할 수 있습니다. 계층적 페이징을 사용하면 CPU가 발생하는 논리 주소는 [외부 페이지, 내부 페이지, 변위] 형태로 구성됩니다.

계층적 페이징은 페이지 폴트 발생 시 메모리 참조 횟수가 많아질 수 있으므로 계층 수가 많다고 항상 좋은 것은 아닙니다.

# 페이지 교체와 프레임 할당

## 요구 페이징

요구 페이징은 프로세스를 메모리에 적재할 때 처음부터 모든 페이지를 적재하지 않고 필요한 페이지만 메모리에 적재하는 기법입니다. 즉, 실제로 페이지가 필요할 때만 메모리에 적재하는 방식입니다.

### 순수 요구 페이징

순수 요구 페이징 기법은 초기에는 아무 페이지도 메모리에 적재하지 않은 상태로 프로세스를 실행하는 방식입니다. 실행 첫 순간부터 페이지 폴트가 계속 발생하며, 필요한 페이지들이 적재된 후에는 페이지 폴트 발생 빈도가 줄어듭니다.

## 페이지 교체 알고리즘

페이지 교체 알고리즘은 실행에 필요한 페이지를 적재하기 위해 메모리에 이미 적재된 페이지를 보조기억장치로 내보내야 할 때 어떤 페이지를 내보낼지 결정하는 방법입니다. 페이지 폴트 횟수를 줄이는 것이 중요한 목표입니다.

### 페이지 폴트 횟수

페이지 폴트는 필요한 페이지가 메모리에 없을 때 발생하는 예외입니다. 페이지 교체 알고리즘의 성능은 페이지 폴트 횟수에 따라 평가됩니다.

### 페이지 참조열

페이지 참조열은 프로세스가 실행되는 동안 페이지들이 참조되는 순서를 기록한 것입니다. 이를 통해 페이지 교체 알고리즘의 효율성을 분석할 수 있습니다.

### FIFO 페이지 교체 알고리즘

FIFO(First-In-First-Out) 페이지 교체 알고리즘은 메모리에 가장 먼저 들어온 페이지를 먼저 내보내는 방식입니다. 구현이 간단하지만 성능이 좋지 않은 경우가 많습니다.

### 2차 기회 페이지 교체 알고리즘

2차 기회 페이지 교체 알고리즘은 FIFO 알고리즘을 개선한 방식으로, 페이지가 교체되기 전에 두 번째 기회를 줍니다. 페이지가 교체될 때 참조 비트를 확인하여 1이면 참조 비트를 0으로 설정하고 교체를 미루며, 0이면 해당 페이지를 교체합니다.

### 최적 페이지 교체 알고리즘

최적 페이지 교체 알고리즘은 앞으로 가장 오랫동안 사용되지 않을 페이지를 교체하는 방식입니다. 이론적으로 가장 효율적이지만, 실제 구현이 어려워 주로 비교 기준으로 사용됩니다.

### LRU 페이지 교체 알고리즘

LRU(Least Recently Used) 페이지 교체 알고리즘은 가장 오랫동안 사용되지 않은 페이지를 교체하는 방식입니다. 과거의 사용 패턴을 기반으로 페이지를 교체하므로, 실용적이고 효율적입니다.

## 스래싱과 프레임 할당

### 스래싱

스래싱은 프로세스가 페이지 폴트로 인해 지속적으로 페이지 교체 작업을 하느라 실제 작업을 거의 수행하지 못하는 상태를 말합니다. 이는 메모리에 비해 너무 많은 페이지를 필요로 하는 경우 발생합니다.

### 멀티프로그래밍의 정도

멀티프로그래밍의 정도는 동시에 메모리에 적재되어 실행되는 프로세스의 수를 의미합니다. 멀티프로그래밍의 정도가 높을수록 스래싱 발생 가능성이 높아집니다.

## 프레임 할당 방식

### 정적 할당 방식

정적 할당 방식은 시스템이 프로세스에 고정된 수의 프레임을 미리 할당하는 방법입니다. 이 방식은 간단하고 예측 가능하지만, 자원의 효율성 측면에서는 한계가 있을 수 있습니다.

- **균등 할당**:
    - 모든 프로세스에 동일한 수의 프레임을 할당합니다.
    - 단순한 구현이 가능하고 관리가 용이하지만, 각 프로세스의 메모리 요구가 다를 경우 비효율적일 수 있습니다.
- **비례 할당**:
    - 프로세스의 크기나 우선순위에 따라 비례적으로 프레임을 할당합니다.
    - 프로세스가 필요로 하는 메모리 양에 따라 프레임 수를 조절하므로 자원을 보다 효율적으로 사용할 수 있습니다.

### 동적 할당 방식

동적 할당 방식은 프로세스의 메모리 요구사항에 따라 프레임을 실시간으로 조절하는 방법입니다. 이 방식은 시스템이 변화하는 조건에 적응하고, 자원을 효율적으로 사용하는 데 도움이 됩니다.

- **작업 집합 모델**:
    - 프로세스가 일정 시간 동안 필요로 하는 페이지 집합을 기준으로 프레임을 할당하는 방식입니다.
    - 작업 집합(Working Set)은 특정 시간 간격 동안 프로세스가 참조한 페이지들의 집합으로, 이 집합이 메모리에 상주해야 스래싱(Thrashing)을 방지할 수 있습니다.
    - 각 프로세스는 자신의 작업 집합 크기에 따라 프레임을 할당습니다.
- **페이지 폴트 빈도**:
    - 페이지 폴트 발생 빈도를 기준으로 프레임을 동적으로 조절하는 방식입니다.
    - 시스템은 각 프로세스의 페이지 폴트 발생 빈도를 지속적으로 모니터링합니다.
    - 페이지 폴트가 자주 발생하면 해당 프로세스에 더 많은 프레임을 할당하고, 페이지 폴트가 드물게 발생하면 할당된 프레임 수를 줄입니다.
