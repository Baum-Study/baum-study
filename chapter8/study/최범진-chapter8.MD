# 장치 컨트롤러와 장치 드라이버

## **장치 컨트롤러**

### **장치 컨트롤러를 사용하는 이유**

- 입출력 장치의 종류가 매우 다양합니다.
- 입출력 장치의 데이터 전송 속도는 CPU와 메모리에 비해 느립니다.

### **장치 컨트롤러의 역할**

- CPU와 입출력 장치 간의 통신을 중개
- 오류 검출
- 데이터 버퍼링

### **데이터 버퍼링**

- 버퍼링은 전송 속도가 다른 장치들 사이의 데이터를 임시 저장 공간인 버퍼에 저장하여 전송 속도를 맞추는 방법입니다.

### **내부 구조**

1. **데이터 레지스터:** CPU와 입출력 장치 간의 데이터를 주고받는 레지스터로, 버퍼 역할을 합니다. 최근에는 RAM을 사용하기도 합니다.
2. **상태 레지스터:** 입출력 장치의 준비 상태, 작업 완료 여부, 오류 여부 등의 상태 정보를 저장합니다.
3. **제어 레지스터:** 입출력 장치가 수행할 제어 정보와 명령을 저장합니다.

## **장치 드라이버**

- 장치 드라이버는 장치 컨트롤러의 동작을 감지하고 제어하여 장치 컨트롤러가 컴퓨터와 정보를 주고받을 수 있게 하는 프로그램입니다.
- 운영체제가 장치 드라이버를 인식하고 제어합니다.

# 다양한 입출력 방법

## **프로그램 입출력**

프로그램 입출력은 프로그램 내의 명령어를 통해 입출력 장치를 제어하는 방법입니다. CPU가 프로그램의 명령어를 실행할 때 입출력 명령어를 만나면, CPU는 장치 컨트롤러와 상호작용하여 작업을 수행합니다.

### **작업 순서**

1. CPU가 장치 컨트롤러의 제어 레지스터에 명령을 보냅니다.
2. 장치 컨트롤러는 입출력 장치의 상태를 확인하고 상태 레지스터에 상태를 저장합니다.
3. CPU가 상태 레지스터를 주기적으로 읽어보며 입출력 장치의 상태를 확인합니다. 입출력 장치가 준비되면 데이터 레지스터에 데이터를 저장하고, 작업이 종료될 때까지 반복합니다.

### **입출력 방식**

1. **메모리 맵 입출력 (Memory-Mapped I/O)**: 메모리와 입출력 장치를 같은 주소 공간으로 간주하는 방법입니다.
    - CPU가 메모리에 접근하는 명령어와 입출력 장치에 접근하는 명령어가 동일합니다.
2. **고립형 입출력 (Isolated I/O)**: 메모리와 입출력 장치를 분리된 주소 공간으로 사용하는 방법입니다.
    - 입출력 전용 명령어를 사용합니다.

| 메모리 맵 입출력 | 고립형 입출력 |
| --- | --- |
| 메모리와 입출력 장치는 같은 주소 공간 사용 | 메모리와 입출력 장치는 분리된 주소 공간 사용 |
| 메모리 주소 공간이 축소됨 | 메모리 주소 공간이 축소되지 않음 |
| 메모리와 입출력 장치가 같은 명령어 사용 | 입출력 전용 명령어 사용 |

## 인터럽트 기반 입출력

인터럽트를 기반으로 하는 입출력 방식은 입출력 장치에 의한 하드웨어 인터럽트를 사용합니다. CPU는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력 장치를 제어하여 작업을 수행한 후, CPU에 인터럽트 요청 신호를 보냅니다. CPU는 인터럽트 서비스 루틴을 실행하여 작업을 처리합니다.

### 작업 방식

- 인터럽트가 발생한 순서대로 처리하는 방법
- 인터럽트 간에 우선순위를 고려하여 처리하는 방법
    - 플래그 레지스터에서 인터럽트가 활성화된 경우
    - 무시할 수 없는 인터럽트인 NMI(Non-maskable Interrupt)가 활성화된 경우
    - PIC(Programmable Interrupt Controller) 하드웨어를 사용하여 우선순위를 반영한 다중 인터럽트 처리

### **PIC(Programmable Interrupt Controller)**

PIC는 여러 장치 컨트롤러에 연결되어 있으며, 이들로부터 보내진 하드웨어 인터럽트 요청의 우선순위를 판별한 뒤, CPU에 현재 처리해야 할 인터럽트를 알려줍니다. PIC에 연결된 장치 컨트롤러들이 동시에 하드웨어 인터럽트 요청을 보내면, PIC는 우선순위를 판단하여 CPU에 가장 먼저 처리할 인터럽트를 알려줍니다.

### PIC의 다중 인터럽트 처리 과정

1. PIC가 장치 컨트롤러로부터 인터럽트 요청 신호를 받습니다.
2. PIC는 인터럽트 우선순위를 판단한 후, CPU에 처리해야 할 인터럽트 요청 신호를 보냅니다.
3. CPU는 PIC에 인터럽트 확인 신호를 보냅니다.
4. PIC는 데이터 버스를 통해 CPU에 인터럽트 벡터를 보냅니다.
5. CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 확인하고, 해당 장치의 인터럽트 서비스 루틴을 실행합니다.

## DMA 입출력

DMA(Direct Memory Access)는 입출력 장치와 메모리가 CPU를 거치지 않고 직접 상호작용하는 입출력 방식입니다. 이를 위해 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어가 필요합니다.

### 입출력 과정

1. CPU가 DMA 컨트롤러에 입출력 장치의 주소, 수행할 연산, 읽거나 쓸 메모리의 주소 등의 정보를 제공하여 입출력 작업을 명령합니다.
2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행합니다. 이때 필요한 경우 메모리에 직접 접근하여 데이터를 읽거나 씁니다.
3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 완료되었음을 알립니다.

### 사이클 스틸링

DMA 컨트롤러가 시스템 버스를 사용할 때, 메모리에 직접 접근할 수 있습니다. 그러나 시스템 버스는 동시 사용이 불가능하므로 CPU가 시스템 버스를 이용하지 않을 때마다 조금씩 시스템 버스를 사용하거나, CPU가 일시적으로 시스템 버스를 이용하지 않도록 허락을 구하고 시스템 버스를 사용합니다. 이를 사이클 스틸링이라고 합니다.

### 입출력 버스

CPU, 메모리, DMA 컨트롤러, 장치 컨트롤러가 모두 같은 버스를 공유하는 구성에서는 메모리에 접근할 때마다 시스템 버스를 두 번 사용하게 되는 부작용이 발생할 수 있습니다. DMA를 위해 시스템 버스를 너무 자주 사용하면 그만큼 CPU가 시스템 버스를 이용하지 못하게 됩니다. 이 문제를 해결하기 위해 DMA 컨트롤러와 장치 컨트롤러들을 입출력 버스라는 별도의 버스에 연결할 수 있습니다. 대표적인 입출력 버스로는 PCI 버스(Peripheral Component Interconnect)와 PCIe(PCI Express) 버스가 있습니다.
